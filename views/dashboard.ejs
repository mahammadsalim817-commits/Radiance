<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Radiance </title>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#667eea">
  <link rel="stylesheet" href="/css/dashboard.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="dashboard-container">
    <header class="dashboard-header">
      <h1>Radiance Camp - Admin Dashboard</h1>
      <div class="header-actions">
        <button onclick="window.print()" class="btn-print">Print Report</button>
        <button onclick="exportToCSV()" class="btn-export">Export CSV</button>
      </div>
    </header>

    <% if (typeof error !== 'undefined' && error) { %>
      <div style="background: #fee2e2; border: 2px solid #f87171; border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem; color: #991b1b;">
        <h3 style="margin-bottom: 0.5rem; font-weight: 600;">⚠️ Connection Error</h3>
        <p style="margin-bottom: 1rem;"><%= error %></p>
        <p style="font-size: 0.875rem;">To fix this:</p>
        <ol style="margin-left: 1.5rem; font-size: 0.875rem; margin-top: 0.5rem;">
          <li>Go to <a href="https://cloud.mongodb.com" target="_blank" style="color: #1e40af; text-decoration: underline;">MongoDB Atlas</a></li>
          <li>Click "Network Access" → "Add IP Address"</li>
          <li>Add your current IP or click "Allow Access from Anywhere"</li>
          <li>Wait 2-3 minutes and refresh this page</li>
        </ol>
      </div>
    <% } %>

    <div class="stats-container">
      <div class="stat-card">
        <div class="stat-icon" style="background: #10b981;">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
            <circle cx="9" cy="7" r="4"></circle>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
          </svg>
        </div>
        <div class="stat-content">
          <h3>Total Registrations</h3>
          <p class="stat-value"><%= stats.total %></p>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon" style="background: #f59e0b;">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <polyline points="12 6 12 12 16 14"></polyline>
          </svg>
        </div>
        <div class="stat-content">
          <h3>Pending Verification</h3>
          <p class="stat-value"><%= stats.pending %></p>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon" style="background: #10b981;">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
            <polyline points="22 4 12 14.01 9 11.01"></polyline>
          </svg>
        </div>
        <div class="stat-content">
          <h3>Verified</h3>
          <p class="stat-value"><%= stats.verified %></p>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon" style="background: #3b82f6;">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
            <line x1="12" y1="1" x2="12" y2="23"></line>
            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
          </svg>
        </div>
        <div class="stat-content">
          <h3>Total Amount (Verified)</h3>
          <p class="stat-value">₹<%= stats.totalAmount %></p>
        </div>
      </div>
    </div>

    <div class="table-container">
      <div class="table-header">
        <h2>Registered Participants</h2>
        <div class="header-controls">
          <select id="statusFilter" class="filter-select">
            <option value="all">All Status</option>
            <option value="pending">Pending</option>
            <option value="verified">Verified</option>
            <option value="rejected">Rejected</option>
          </select>
          <input type="text" id="searchInput" placeholder="Search by name, unit, or sector..." class="search-input">
        </div>
      </div>

      <div class="table-wrapper">
        <table class="data-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Name</th>
              <th>Age</th>
              <th>Unit</th>
              <th>Sector</th>
              <th>Phone</th>
              <th>Screenshot</th>
              <th>Amount</th>
              <th>Date</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <% registrations.forEach((reg, index) => { %>
              <tr data-id="<%= reg._id %>" data-status="<%= reg.paymentStatus %>">
                <td><%= index + 1 %></td>
                <td><%= reg.name %></td>
                <td><%= reg.age %></td>
                <td><%= reg.unit %></td>
                <td><%= reg.sector %></td>
                <td><%= reg.phoneNumber %></td>
                <td>
                  <% if (reg.paymentScreenshot) { %>
                    <button class="btn-view-screenshot" onclick="viewScreenshot('<%= reg.paymentScreenshot %>', '<%= reg.name %>')">
                      <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
                        <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/>
                      </svg>
                      View
                    </button>
                  <% } else { %>
                    <span class="no-screenshot">N/A</span>
                  <% } %>
                </td>
                <td>₹<%= reg.amount %></td>
                <td><%= new Date(reg.registeredAt).toLocaleDateString('en-IN') %></td>
                <td>
                  <span class="status-badge status-<%= reg.paymentStatus %>"><%= reg.paymentStatus %></span>
                </td>
                <td>
                  <% if (reg.paymentStatus === 'pending') { %>
                    <div class="action-buttons">
                      <button class="btn-approve" onclick="verifyPayment('<%= reg._id %>', 'verified')">
                        <svg width="14" height="14" viewBox="0 0 20 20" fill="currentColor">
                          <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                        </svg>
                        Approve
                      </button>
                      <button class="btn-reject" onclick="verifyPayment('<%= reg._id %>', 'rejected')">
                        <svg width="14" height="14" viewBox="0 0 20 20" fill="currentColor">
                          <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                        </svg>
                        Reject
                      </button>
                    </div>
                  <% } else { %>
                    <span style="color: #6b7280; font-size: 0.8125rem;">
                      <%= reg.paymentStatus === 'verified' ? '✓ Approved' : '✗ Rejected' %>
                    </span>
                  <% } %>
                </td>
              </tr>
            <% }); %>
          </tbody>
        </table>

        <% if (registrations.length === 0) { %>
          <div class="no-data">
            <p>No registrations found</p>
          </div>
        <% } %>
      </div>
    </div>
  </div>

  <script>
    // Search and Filter functionality
    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');
    const tableRows = document.querySelectorAll('#tableBody tr');

    function filterTable() {
      const searchTerm = searchInput.value.toLowerCase();
      const statusValue = statusFilter.value;
      
      tableRows.forEach(row => {
        const text = row.textContent.toLowerCase();
        const status = row.dataset.status;
        
        const matchesSearch = text.includes(searchTerm);
        const matchesStatus = statusValue === 'all' || status === statusValue;
        
        row.style.display = (matchesSearch && matchesStatus) ? '' : 'none';
      });
    }

    searchInput.addEventListener('input', filterTable);
    statusFilter.addEventListener('change', filterTable);

    // View Payment Screenshot
    function viewScreenshot(imagePath, name) {
      const modal = document.createElement('div');
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 9999; padding: 2rem;';
      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; padding: 2rem; max-width: 800px; max-height: 90vh; overflow: auto; position: relative;">
          <button onclick="this.parentElement.parentElement.remove()" style="position: absolute; top: 1rem; right: 1rem; background: #ef4444; color: white; border: none; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; font-size: 1.5rem; line-height: 1; display: flex; align-items: center; justify-content: center;">&times;</button>
          <h3 style="margin-bottom: 1rem; color: #111827;">Payment Screenshot - ${name}</h3>
          <img src="${imagePath}" style="max-width: 100%; height: auto; border-radius: 8px; border: 2px solid #e5e7eb;">
        </div>
      `;
      document.body.appendChild(modal);
      modal.addEventListener('click', function(e) {
        if (e.target === modal) modal.remove();
      });
    }

    // Verify Payment
    async function verifyPayment(registrationId, status) {
      const confirmMsg = status === 'verified' 
        ? 'Are you sure you want to approve this registration?' 
        : 'Are you sure you want to reject this registration?';
      
      if (!confirm(confirmMsg)) return;

      try {
        const response = await fetch(`/api/admin/verify/${registrationId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ status })
        });

        const data = await response.json();

        if (data.success) {
          alert(data.message);
          location.reload();
        } else {
          throw new Error(data.error);
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Failed to verify payment: ' + error.message);
      }
    }

    // Safely inject registrations data as JSON
    // This avoids EJS/JS syntax issues and template parse errors
    </script>
    <script type="application/json" id="registrations-data">
      <%- JSON.stringify(registrations || []) %>
    </script>
    <script>
    // Export to CSV
    function exportToCSV() {
      const registrations = JSON.parse(document.getElementById('registrations-data').textContent);
      let csv = 'Name,Age,Unit,Sector,Phone Number,Transaction ID,Amount,Registration Date,Status\n';
      registrations.forEach(reg => {
        const txnId = reg.transactionId || reg.paymentId || 'N/A';
        csv += `"${reg.name}",${reg.age},"${reg.unit}","${reg.sector}","${reg.phoneNumber}","${txnId}",${reg.amount},"${new Date(reg.registeredAt).toLocaleString('en-IN')}","${reg.paymentStatus}"\n`;
      });
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `sahityotsava_registrations_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      window.URL.revokeObjectURL(url);
    }
    </script>
  </script>
</body>
</html>

